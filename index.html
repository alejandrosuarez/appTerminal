<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Terminal Chat Simulator</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Particles.js CDN with fallback -->
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js" onload="initParticles()" onerror="console.error('Particles.js failed to load, falling back to plain background');"></script>
  <script src="voice.js"></script>
  <style>
    body {
      background: #0a0e14; /* Dark cyberpunk background */
      color: #00ff99; /* Neon green text */
      font-family: 'Courier New', monospace; /* Terminal font */
      margin: 0;
      height: 100vh;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    #terminal {
      height: 100%;
      padding: 20px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.9);
      border: 2px solid #00ff99;
      box-shadow: 0 0 10px #00ff99, 0 0 20px #00ff33 inset;
    }
    #output {
      white-space: pre-wrap; /* Preserve whitespace and newlines from server.js */
      margin: 0;
      padding: 0;
      line-height: 1.4;
    }
    .prompt {
      display: inline;
      color: #00ffcc;
    }
    .typing {
      animation: blink 0.7s step-end infinite;
      color: #ff00ff; /* Neon purple for typing */
    }
    @keyframes blink {
      50% { opacity: 0; }
    }
    @keyframes glitch {
      2%, 64% {
        transform: translate(2px, 0) skew(0deg);
      }
      4%, 60% {
        transform: translate(-2px, 0) skew(0deg);
      }
      62% {
        transform: translate(0, 0) skew(5deg);
      }
    }
    .glitch {
      animation: glitch 2s linear infinite;
    }
    #input {
      background: transparent;
      border: none;
      color: #00ff99;
      width: 80%;
      outline: none;
      font-family: 'Courier New', monospace;
    }
    #input::placeholder {
      color: #00cc66;
    }
    button {
      background: #00ff99;
      border: none;
      padding: 5px 10px;
      color: #0a0e14;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    button:hover {
      background: #ff00ff;
      color: #00ff99;
      box-shadow: 0 0 15px #ff00ff;
    }
    .particle {
      position: absolute;
      width: 2px;
      height: 2px;
      background: #00ffcc;
      border-radius: 50%;
      animation: pulse 3s infinite;
    }
    @keyframes pulse {
      0% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.5); }
      100% { opacity: 0.3; transform: scale(1); }
    }
    #pushToTalk { padding: 5px 10px; background-color: #ff4444; color: white; border: none; cursor: pointer; }
    #pushToTalk.active { background-color: #00cc00; }
  </style>
</head>
<body>
  <div id="terminal" class="glitch">
    <div id="output"></div>
    <div class="prompt">$ </div><input type="text" id="input" placeholder="Enter command..." autocomplete="off">
    <button onclick="sendMessage()">Execute</button>
    <button id="pushToTalk" onclick="handlePushToTalk()" style="display: none;">Tap to Talk</button>
  </div>

  <script>
    // Particles.js Initialization with fallback
    function initParticles() {
      particlesJS({
        particles: {
          number: { value: 50, density: { enable: true, value_area: 800 } },
          color: { value: "#00ffcc" },
          shape: { type: "circle" },
          opacity: { value: 0.3, random: true },
          size: { value: 2, random: true },
          move: { enable: true, speed: 1, direction: "none", random: true },
        },
        interactivity: {
          detectsOn: "canvas",
          modes: { repulse: { distance: 50 } },
        },
      });
    }

    // WebSocket Logic with Error Handling
     // Dynamically set WebSocket URL for local testing and production
    const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    const wsUrl = isLocal
      ? 'ws://localhost:5000' // Your local server URL
      : 'wss://appterminal.onrender.com'; // Your production Render URL

    const ws = new WebSocket(wsUrl);
    const output = document.getElementById('output');
    const input = document.getElementById('input');
    let isTyping = false;
    let isInChat = false; // Track chat state

    ws.onopen = () => {
      console.log('WebSocket connection opened');
      output.innerHTML += '<div>Connected to Terminal Chat Simulator at 03:00 PM -05, Monday, June 09, 2025.</div>\n';
      if (typeof initializeVoice === 'function') {
        initializeVoice(ws); // Initialize voice module only if function exists
      } else {
        console.error('initializeVoice function not loaded');
      }
    };

    ws.onmessage = (event) => {
      let messageData;
      let isVoiceMessage = false;

      // Try to parse the message as JSON
      try {
        messageData = JSON.parse(event.data);
        if (messageData.type === 'voiceMessage') {
          isVoiceMessage = true;
        }
      } catch (e) {
        // If it's not JSON, treat it as a plain text message
        messageData = event.data;
      }

      // --- FIX: Add back the button visibility logic ---
      if (typeof messageData === 'string') {
        // Show the button when the user successfully joins the chat
        if (messageData.includes('Welcome,')) {
          isInChat = true;
          document.getElementById('pushToTalk').style.display = 'inline-block';
        }
        // Hide the button if the user leaves or is disconnected
        else if (messageData.includes('You have left the chat') || messageData.includes('Disconnected')) {
          isInChat = false;
          document.getElementById('pushToTalk').style.display = 'none';
        }
      }
      // --- END OF FIX ---

      // Stop the "AI is typing..." indicator
      const typingIndicator = output.querySelector('.typing');
      if (typingIndicator) {
        typingIndicator.remove();
      }

      if (isVoiceMessage) {
        // Create the UI for the on-demand voice message
        const messageContainer = document.createElement('div');
        messageContainer.style.marginBottom = '10px';
        const senderText = document.createTextNode(`> Voice message from ${messageData.senderName}: `);
        messageContainer.appendChild(senderText);
        const playButton = document.createElement('button');
        playButton.textContent = 'Play Audio';
        playButton.dataset.audioSrc = messageData.audioData;
        playButton.onclick = (e) => {
          const audioSrc = e.currentTarget.dataset.audioSrc;
          const audio = new Audio(audioSrc);
          audio.play();
        };
        messageContainer.appendChild(playButton);
        output.appendChild(messageContainer);

      } else {
        // Handle regular text messages
        if (typeof messageData === 'string' && messageData.includes('AI is typing...')) {
          output.innerHTML += '<div class="typing">' + messageData + '</div>\n';
        } else {
          output.innerHTML += '<div>' + messageData + '</div>\n';
        }
      }

      // Scroll to the bottom
      output.scrollTop = output.scrollHeight;
    };

    ws.onclose = () => {
      console.log('WebSocket connection closed');
      output.innerHTML += '<div>Disconnected from Terminal Chat Simulator.</div>\n';
    };

    ws.onerror = (error) => {
      console.error('WebSocket error:', error);
      output.innerHTML += '<div>Error: WebSocket connection failed. Check console for details.</div>\n';
    };

    function sendMessage() {
      const message = input.value;
      if (message) {
        output.innerHTML += '<div class="prompt">$ </div>' + message + '\n';
        ws.send(message);
        input.value = '';
        output.scrollTop = output.scrollHeight;
      }
    }

    input.addEventListener('keypress', (event) => {
      if (event.key === 'Enter') {
        sendMessage();
      }
    });

    // Dynamic Particles
    function createParticle() {
      const particle = document.createElement('div');
      particle.className = 'particle';
      particle.style.left = Math.random() * 100 + 'vw';
      particle.style.top = Math.random() * 100 + 'vh';
      document.body.appendChild(particle);
      setTimeout(() => particle.remove(), 3000);
    }
    setInterval(createParticle, 200);

    // Voice Integration
    const pushToTalkButton = document.getElementById('pushToTalk');
    function handlePushToTalk() { // Renamed to avoid conflict
      if (isInChat) { // Only allow if in chat
        if (typeof togglePushToTalkInternal === 'function') {
          togglePushToTalkInternal(ws, pushToTalkButton);
        } else {
          output.innerHTML += '<div>Error: togglePushToTalkInternal function not loaded.</div>\n';
          output.scrollTop = output.scrollHeight;
        }
      } else {
        output.innerHTML += '<div>Please join the chat with "chat" first.</div>\n';
        output.scrollTop = output.scrollHeight;
      }
    }
  </script>
</body>
</html>